<script>
(function(win, lib) {
	if (lib.callapp) return;
	var ua = navigator.userAgent;
	var browser = {
		isSafari: /Version\/[\d\.]+.*Safari/.test(ua),
		// isChrome: /Chrome/i.test(ua),
		chromeV: ua.match(/Chrome\/(\d+)/),
		isAndroid: /Android/i.test(ua),
		isIOS: /iPhone|iPad|iPod/i.test(ua),
		isWechat: /MicroMessenger/i.test(ua),
		iosVersion: function () {
			if (/iP(hone|od|ad)/.test(navigator.platform)) {
				var v = (navigator.appVersion).match(/OS (\d+)_(\d+)_?(\d+)?/);
				return [parseInt(v[1], 10), parseInt(v[2], 10), parseInt(v[3] || 0, 10)];
			}
			return null;
		}
	};

	/**
	 * 插入微信提示
	 */
	function writeWechatTip() {
		document.body = document.createElement('body');
		var divEle = document.createElement("div");
		divEle.className = "wechat-tip";
		divEle.id = "JwechatTip";
		divEle.innerHTML = '<img style="width:100%; height:100%; z-index:-1;background-size: cover;" src="http://consumer.huawei.com/content/dam/huawei-cbg-site/cn/support/applinks/web_en.png" />'
		document.body.appendChild(divEle);
		divEle.addEventListener("click",function(){
			divEle.style.display = "none";
		},false);
	}

	lib.callapp = function(o) {
		if (!o || typeof(o) != "object") return;
		if (typeof(o.scheme) == "undefined" || o.scheme == "") return;
		if (typeof(o.package) == "undefined" || o.package == "") return;
		if (typeof(o.schemeUrl) != "undefined" && o.schemeUrl != "") {
			//此处只服务于华为android手机无需进行机型判断了
			if (browser.isWechat) {
				writeWechatTip();
			} else {
				var url = window.location.search; //获取url中"?"符后的字串
				url.indexOf('?');
				o.schemeUrl += url.substr(0);
				win.location.href = o.schemeUrl; //先去尝试拉取目标app					
				var t = Date.now();
				var loadTimer = setTimeout(function() {
					if (!document.hidden && !document.webkitHidden && Date.now() - t < o.iconnectTime) {
						o.iconnectUrl += url.substr(0);
						win.location.href = o.iconnectUrl; //如果目标app拉起不起来，尝试去拉iconnect的app
						t = Date.now();
						loadTimer = setTimeout(function() {
							if (!document.hidden && !document.webkitHidden && Date.now() - t < o.downloadTime) {
								win.location.href = o.dowmloadUrl; //如果目标app拉起不起来，尝试去拉iconnect的app
							}
						}, 1000);
					}
				}, 1000);
				// 当本地app被唤起，则页面会隐藏掉，就会触发pagehide与visibilitychange事件
				// 在部分浏览器中可行，网上提供方案，作hack处理
				var visibilitychange = function() {
					var tag = document.hidden || document.webkitHidden;
					tag && clearTimeout(loadTimer);
					window.history.back(); //消除访问记录，防止浏览器强杀后再打开会重复拉起
				};
				document.addEventListener('visibilitychange', visibilitychange, false);
				document.addEventListener('webkitvisibilitychange', visibilitychange, false);
			}
		}
	}
})(window, window.lib || (window.lib = {}));
</script>

<script type="text/javascript">
function loadCallapp(fn) {
	fn = fn || function() {};
	if (window.lib && typeof(window.lib.callapp) != "undefined") {
		fn();
	}
}

lib.callapp({
	"scheme":"com.huawei.pcassistant",
	"package":"com.huawei.pcassistant",
	"schemeUrl":"com.huawei.pcassistant://mainactivity", //目标app拉取的scheme
	"iconnectUrl":"com.huawei.pcassistant.installer://InstallerActivity", //如果目标app不存在首先去拉取华为内置app iconnect的scheme
	"iconnectTime":"1200", //等待多久去拉取内置app
	"dowmloadUrl":"http://consumer.huawei.com/content/dam/huawei-cbg-site/cn/support/applinks/HwPCAssistant.apk", //目标app的下载地址
	"downloadTime":"1200" //等待多久去下载目标app
});

</script>
